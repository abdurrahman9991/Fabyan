<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Telegram Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-700 text-white shadow-md">
        <div class="container mx-auto flex items-center justify-between px-4 py-3">
            <div class="flex items-center gap-3">
                <img src="https://telegram.org/img/t_logo.png" alt="Telegram" class="w-10 h-10 rounded-full shadow">
                <span class="font-bold text-xl tracking-wide">Telegram Mini App</span>
            </div>
            <div id="user-info" class="text-sm text-right"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 container mx-auto px-4 py-6">
        <!-- Content will be injected here -->
    </main>

    <!-- Bottom Navbar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t z-50">
        <div class="container mx-auto flex justify-between px-4">
            <button id="nav-home" class="nav-btn flex flex-col items-center flex-1 py-2 text-blue-700" aria-label="Home">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l9-9 9 9M4 10v10a1 1 0 001 1h3m10-11v10a1 1 0 01-1 1h-3m-6 0h6"></path></svg>
                <span class="text-xs font-medium">Home</span>
            </button>
            <button id="nav-task" class="nav-btn flex flex-col items-center flex-1 py-2 text-gray-500" aria-label="Task">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2l4-4M7 7h10M7 17h10"></path></svg>
                <span class="text-xs font-medium">Task</span>
            </button>
            <button id="nav-reffer" class="nav-btn flex flex-col items-center flex-1 py-2 text-gray-500" aria-label="Refer">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a4 4 0 00-3-3.87M9 20H4v-2a4 4 0 013-3.87M16 3.13a4 4 0 010 7.75M8 3.13a4 4 0 000 7.75"></path></svg>
                <span class="text-xs font-medium">Refer</span>
            </button>
            <button id="nav-wallet" class="nav-btn flex flex-col items-center flex-1 py-2 text-gray-500" aria-label="Wallet">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path><circle cx="16" cy="8" r="2"></circle></svg>
                <span class="text-xs font-medium">Wallet</span>
            </button>
        </div>
    </nav>

    <!-- Telegram WebApp JS SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Telegram WebApp user authentication
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user;

        // Replace these mock values with backend data
        let currentBalance = 0;
        let totalCompletedTasks = 0;

        // Fetch user data from backend
        async function fetchUserData() {
            if (!user) return;
            try {
                const res = await fetch(`http://localhost:3000/api/user/${user.id}`);
                if (res.ok) {
                    const data = await res.json();
                    currentBalance = data.balance;
                    totalCompletedTasks = data.completedTasks;
                }
            } catch (e) {
                console.error('Failed to fetch user data', e);
            }
        }

        // Send withdraw request to backend
        async function sendWithdrawRequest({ userId, method, number, amount }) {
            try {
                const res = await fetch('http://localhost:3000/api/withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, method, number, amount })
                });
                return await res.json();
            } catch (e) {
                return { ok: false, error: 'Network error' };
            }
        }

        function showUserInfo() {
            const info = document.getElementById('user-info');
            if (user) {
                info.innerHTML = `
                    <span class="block font-semibold">ðŸ‘¤ ${user.first_name} ${user.last_name || ''}</span>
                    <span class="block text-xs opacity-80">ID: ${user.id}</span>
                `;
            } else {
                info.innerHTML = `<span>Not Authenticated</span>`;
            }
        }

        // Card component for user stats
        function userStatsCard() {
            return `
                <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white rounded-xl shadow p-5 flex flex-col items-center">
                        <span class="text-gray-500 text-xs mb-1">User Number</span>
                        <span class="text-lg font-bold">${user ? user.id : '-'}</span>
                    </div>
                    <div class="bg-white rounded-xl shadow p-5 flex flex-col items-center">
                        <span class="text-gray-500 text-xs mb-1">Balance</span>
                        <span class="text-lg font-bold text-green-600">$${currentBalance.toFixed(2)}</span>
                    </div>
                    <div class="bg-white rounded-xl shadow p-5 flex flex-col items-center">
                        <span class="text-gray-500 text-xs mb-1">Completed Tasks</span>
                        <span class="text-lg font-bold text-blue-700">${totalCompletedTasks}</span>
                    </div>
                </section>
            `;
        }

        // Home Section with Start Earning Button
        function homeSection() {
            return `
                <h1 class="text-2xl font-bold mb-4">Welcome${user ? ', ' + user.first_name : ''}!</h1>
                ${userStatsCard()}
                <div class="flex justify-center mb-6">
                    <button id="start-earning-btn" class="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-green-400 text-white px-6 py-3 rounded-full shadow-lg font-semibold text-lg hover:scale-105 transition-transform">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                        Start Earning
                    </button>
                </div>
                <section>
                    <p class="text-gray-700">This is the Home page of your Telegram Mini App. Here you can see your account summary and stats.</p>
                </section>
            `;
        }

        // Task Card Component
        function taskCard({title, description, reward, idx}) {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mb-5 flex flex-col sm:flex-row items-center gap-4 border border-blue-100 hover:shadow-2xl transition-shadow">
                    <div class="flex-1">
                        <h2 class="text-lg font-bold text-blue-700 flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.967a1 1 0 00.95.69h4.175c.969 0 1.371 1.24.588 1.81l-3.38 2.455a1 1 0 00-.364 1.118l1.287 3.966c.3.921-.755 1.688-1.54 1.118l-3.38-2.454a1 1 0 00-1.175 0l-3.38 2.454c-.784.57-1.838-.197-1.54-1.118l1.287-3.966a1 1 0 00-.364-1.118L2.049 9.394c-.783-.57-.38-1.81.588-1.81h4.175a1 1 0 00.95-.69l1.286-3.967z"/></svg>
                            ${title}
                        </h2>
                        <p class="text-gray-600 mb-3">${description}</p>
                        <span class="inline-block bg-green-100 text-green-700 text-xs px-3 py-1 rounded-full font-semibold mb-2">Reward: $${reward}</span>
                    </div>
                    <button class="do-task-btn flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full font-semibold shadow transition" data-idx="${idx}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"></path></svg>
                        Do Task
                    </button>
                </div>
            `;
        }

        // Task Section with Multiple Cards
        function taskSection() {
            const tasks = [
                {title: "Watch Ad", description: "Watch a short video ad and earn instant rewards.", reward: "0.50"},
                {title: "Join Channel", description: "Join our Telegram channel to stay updated and get rewards.", reward: "0.30"},
                {title: "Complete Survey", description: "Fill out a quick survey and help us improve.", reward: "1.00"},
            ];
            setTimeout(() => {
                document.querySelectorAll('.do-task-btn').forEach((btn, idx) => {
                    btn.onclick = () => {
                        showAdAndReward(tasks[idx].reward, () => {
                            loadTask();
                        });
                    };
                });
            }, 0);
            return `
                <h1 class="text-2xl font-bold mb-4">Tasks</h1>
                <div>
                    ${tasks.map((task, idx) => taskCard({...task, idx})).join('')}
                </div>
                <section class="mt-6">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg flex items-center gap-3">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"></path></svg>
                        <span class="text-blue-700 font-medium">Complete more tasks to earn higher rewards and unlock achievements!</span>
                    </div>
                </section>
            `;
        }

        // Add modal HTML to the body (replace the ad image with Monetag rewarded ad)
        const adModalHTML = `
        <div id="ad-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 max-w-sm w-full text-center relative">
                <h2 class="text-xl font-bold mb-4">Sponsored Ad</h2>
                <p class="mb-6">Watch this ad to earn your reward!</p>
                <div class="mb-6" id="monetag-ad-container">
                    <!-- Monetag rewarded ad will be shown here -->
                </div>
                <div id="ad-timer" class="text-blue-700 font-semibold mb-4"></div>
                <button id="ad-close-btn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold" style="display:none;">Close</button>
            </div>
        </div>
        `;
        document.body.insertAdjacentHTML('beforeend', adModalHTML);

        // Show ad modal and handle reward with Monetag
        function showAdAndReward(reward, onComplete) {
            const modal = document.getElementById('ad-modal');
            const timerEl = document.getElementById('ad-timer');
            const closeBtn = document.getElementById('ad-close-btn');
            timerEl.textContent = '';
            closeBtn.style.display = 'none';
            modal.classList.remove('hidden');

            // Show Monetag rewarded interstitial ad
            if (typeof show_10042745 === 'function') {
                show_10042745().then(() => {
                    // User watched the ad, reward them
                    currentBalance += parseFloat(reward);
                    alert(`You earned $${reward}!`);
                    modal.classList.add('hidden');
                    if (typeof onComplete === 'function') onComplete();
                }).catch(() => {
                    alert('Ad was not completed.');
                    modal.classList.add('hidden');
                });
            } else {
                // Fallback if Monetag is not loaded
                timerEl.textContent = 'Ad failed to load. Please try again.';
                closeBtn.style.display = '';
                closeBtn.onclick = () => {
                    modal.classList.add('hidden');
                };
            }
        }

        // Navbar navigation
        const mainContent = document.getElementById('main-content');
        function loadHome() {
            mainContent.innerHTML = homeSection();
            setActive('nav-home');
            // Add event listener for Start Earning button
            setTimeout(() => {
                const btn = document.getElementById('start-earning-btn');
                if (btn) btn.onclick = loadTask;
            }, 0);
        }
        function loadTask() {
            mainContent.innerHTML = taskSection();
            setActive('nav-task');
        }
        function loadReffer() {
            // Generate referral link using Telegram user ID
            const userId = user ? user.id : '';
            const referralLink = userId
                ? `https://t.me/YOUR_BOT_USERNAME?start=${userId}`
                : 'Login to get your referral link';

            mainContent.innerHTML = `
                <h1 class="text-2xl font-bold mb-4">Refer & Earn</h1>
                <section class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-semibold mb-2 text-blue-700">Invite Friends & Earn Rewards!</h2>
                    <p class="text-gray-700 mb-4">
                        Share your unique referral link with friends. When they join and complete their first task, you both earn a bonus!
                    </p>
                    <div class="mb-4">
                        <span class="block text-gray-600 mb-1 font-medium">Your Referral Link:</span>
                        <div class="flex items-center gap-2">
                            <input type="text" readonly value="${referralLink}" class="flex-1 px-3 py-2 border rounded bg-gray-100 text-gray-800 text-sm" id="ref-link-input">
                            <button onclick="navigator.clipboard.writeText('${referralLink}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-semibold">Copy</button>
                        </div>
                    </div>
                    <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded flex items-center gap-3 mt-4">
                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"></path></svg>
                        <span class="text-green-700 font-medium">Referral Bonus: <span class="font-bold">$0.25</span> for each friend who joins and completes a task!</span>
                    </div>
                </section>
            `;
            setActive('nav-reffer');
        }
        function loadWallet() {
            mainContent.innerHTML = `
        <h1 class="text-2xl font-bold mb-4">Wallet</h1>
        <section class="bg-white rounded-xl shadow p-6 mb-4">
            <div class="flex flex-col sm:flex-row sm:justify-between gap-4">
                <div>
                    <span class="block text-gray-500 text-xs mb-1">Balance</span>
                    <span class="text-lg font-bold text-green-600">$${currentBalance.toFixed(2)}</span>
                </div>
                <div>
                    <span class="block text-gray-500 text-xs mb-1">User Number</span>
                    <span class="text-lg font-bold">${user ? user.id : '-'}</span>
                </div>
            </div>
        </section>
        <section>
            <p class="text-gray-700 mb-4">Manage your wallet and transactions here.</p>
            <button id="withdraw-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded font-semibold shadow transition disabled:opacity-60" ${currentBalance < 10 ? 'disabled' : ''}>
                Withdraw
            </button>
            <span class="block text-xs text-gray-500 mt-2">Minimum withdraw amount is $10</span>
        </section>
        <div id="withdraw-modal-root"></div>
    `;
            setActive('nav-wallet');

            // Withdraw button event
            setTimeout(() => {
                const withdrawBtn = document.getElementById('withdraw-btn');
                if (withdrawBtn) {
                    withdrawBtn.onclick = () => showWithdrawModal();
                }
            }, 0);
        }

        // Withdraw Modal
        function showWithdrawModal() {
            const modalRoot = document.getElementById('withdraw-modal-root');
            modalRoot.innerHTML = `
        <div id="withdraw-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm relative">
                <h2 class="text-xl font-bold mb-4 text-blue-700">Withdraw Request</h2>
                <form id="withdraw-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-1">Payment Method</label>
                        <select id="payment-method" class="w-full border rounded px-3 py-2" required>
                            <option value="">Select</option>
                            <option value="bkash">bKash</option>
                            <option value="nagad">Nagad</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-1">Number</label>
                        <input id="payment-number" type="text" maxlength="11" pattern="\\d{11}" class="w-full border rounded px-3 py-2" placeholder="e.g. 01XXXXXXXXX" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-1">Amount ($)</label>
                        <input id="withdraw-amount" type="number" min="10" max="${Math.floor(currentBalance)}" class="w-full border rounded px-3 py-2" value="10" required>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" id="withdraw-cancel" class="bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold">Cancel</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    `;

            // Cancel button
            document.getElementById('withdraw-cancel').onclick = () => {
                modalRoot.innerHTML = '';
            };

            // Form submit
            document.getElementById('withdraw-form').onsubmit = function(e) {
                e.preventDefault();
                const method = document.getElementById('payment-method').value;
                const number = document.getElementById('payment-number').value;
                const amount = parseFloat(document.getElementById('withdraw-amount').value);

                // Validation
                if (!method || !/^\d{11}$/.test(number) || isNaN(amount) || amount < 10 || amount > currentBalance) {
                    alert('Please fill all fields correctly.');
                    return;
                }

                // Confirm/Decline popup
                showWithdrawConfirm({method, number, amount});
            };
        }

        // Confirm/Decline Modal
        function showWithdrawConfirm({ method, number, amount }) {
            const modalRoot = document.getElementById('withdraw-modal-root');
            modalRoot.innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm relative">
                <h2 class="text-xl font-bold mb-4 text-blue-700">Confirm Withdraw</h2>
                <div class="mb-4">
                    <div class="mb-2"><span class="font-semibold">Method:</span> ${method}</div>
                    <div class="mb-2"><span class="font-semibold">Number:</span> ${number}</div>
                    <div class="mb-2"><span class="font-semibold">Amount:</span> $${amount.toFixed(2)}</div>
                </div>
                <div class="flex justify-end gap-2">
                    <button id="withdraw-decline" class="bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold">Decline</button>
                    <button id="withdraw-confirm" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Confirm</button>
                </div>
            </div>
        </div>
    `;

            document.getElementById('withdraw-decline').onclick = () => {
                modalRoot.innerHTML = '';
            };
            document.getElementById('withdraw-confirm').onclick = async () => {
                // Send request to backend
                const result = await sendWithdrawRequest({
                    userId: user ? user.id : '',
                    method,
                    number,
                    amount
                });
                modalRoot.innerHTML = '';
                if (result.ok) {
                    currentBalance -= amount;
                    alert('Withdraw request submitted!');
                    loadWallet();
                } else {
                    alert('Withdraw failed: ' + (result.error || 'Unknown error'));
                }
            };
        }

        // Utility function to set the active navbar button
        function setActive(activeId) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.id === activeId) {
                    btn.classList.add('text-blue-700');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.remove('text-blue-700');
                    btn.classList.add('text-gray-500');
                }
            });
        }

        document.getElementById('nav-home').onclick = loadHome;
        document.getElementById('nav-task').onclick = loadTask;
        document.getElementById('nav-reffer').onclick = loadReffer;
        document.getElementById('nav-wallet').onclick = loadWallet;

        // On page load, fetch user data from backend
        (async function () {
            showUserInfo();
            await fetchUserData();
            loadHome();
        })();
    </script>

    <!-- Monetag Ad Script -->
<script async="async" data-cfasync="false" src="//pl20548485.highcpmrevenuegate.com/1c6b4e2b3a2b6f7b7e1b6e2e3e3b3e2e/invoke.js"></script>
<!--
    âš ï¸ SECURITY WARNING:
    Never paste your Telegram bot token here or in any frontend code.
    Use your bot token only on your backend server (Node.js, Python, PHP, etc.)
    Example (Node.js):
    // const bot = new TelegramBot('YOUR_BOT_TOKEN', options);
-->
</body>
</html>