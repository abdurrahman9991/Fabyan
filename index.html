<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Telegram Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     Tailwind CSS CDN 
    <script src="https://cdn.tailwindcss.com"></script>
     Supabase JS SDK 
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

     Header 
    <header class="bg-blue-700 text-white shadow-md">
        <div class="container mx-auto flex items-center justify-between px-4 py-3">
            <div class="flex items-center gap-3">
                <img src="https://telegram.org/img/t_logo.png" alt="Telegram" class="w-10 h-10 rounded-full shadow">
                <span class="font-bold text-xl tracking-wide">Telegram Mini App</span>
            </div>
            <div id="user-info" class="text-sm text-right"></div>
        </div>
    </header>

     Main Content 
    <main id="main-content" class="flex-1 container mx-auto px-4 py-6">
         Content will be injected here 
    </main>

     Bottom Navbar 
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t z-50">
        <div class="container mx-auto flex justify-between px-4">
            <button id="nav-home" class="nav-btn flex flex-col items-center flex-1 py-2 text-blue-700" aria-label="Home">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l9-9 9 9M4 10v10a1 1 0 001 1h3m10-11v10a1 1 0 01-1 1h-3m-6 0h6"></path></svg>
                <span class="text-xs font-medium">Home</span>
            </button>
            <button id="nav-task" class="nav-btn flex flex-col items-center flex-1 py-2 text-gray-500" aria-label="Task">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2l4-4M7 7h10M7 17h10"></path></svg>
                <span class="text-xs font-medium">Task</span>
            </button>
            <button id="nav-reffer" class="nav-btn flex flex-col items-center flex-1 py-2 text-gray-500" aria-label="Refer">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a4 4 0 00-3-3.87M9 20H4v-2a4 4 0 013-3.87M16 3.13a4 4 0 010 7.75M8 3.13a4 4 0 000 7.75"></path></svg>
                <span class="text-xs font-medium">Refer</span>
            </button>
            <button id="nav-wallet" class="nav-btn flex flex-col items-center flex-1 py-2 text-gray-500" aria-label="Wallet">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path><circle cx="16" cy="8" r="2"></circle></svg>
                <span class="text-xs font-medium">Wallet</span>
            </button>
        </div>
    </nav>

     Telegram WebApp JS SDK 
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const SUPABASE_URL = 'NEXT_PUBLIC_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'NEXT_PUBLIC_SUPABASE_ANON_KEY';
        
        // Create Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Telegram WebApp user authentication
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user;

        // User data variables
        let userData = null;
        let currentBalance = 0;
        let totalCompletedTasks = 0;

        async function fetchUserData(userId) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    console.log('[v0] User not found, will create on first action');
                    return null;
                }
                return data;
            } catch (e) {
                console.error('[v0] Error fetching user:', e);
                return null;
            }
        }

        async function upsertUser(userId, userName, referredBy = null) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .upsert({
                        id: userId,
                        name: userName,
                        referred_by: referredBy
                    }, {
                        onConflict: 'id'
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                return data;
            } catch (e) {
                console.error('[v0] Error upserting user:', e);
                return null;
            }
        }

        async function fetchTasks() {
            try {
                const { data, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                return data || [];
            } catch (e) {
                console.error('[v0] Error fetching tasks:', e);
                return [];
            }
        }

        async function sendWithdrawRequest({ userId, method, number, amount }) {
            try {
                const { data, error } = await supabase
                    .from('withdrawals')
                    .insert({
                        user_id: userId,
                        method: method,
                        number: number,
                        amount: amount,
                        status: 'pending'
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update user balance
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ balance: currentBalance - amount })
                    .eq('id', userId);
                
                if (updateError) throw updateError;
                
                return { ok: true, data };
            } catch (e) {
                console.error('[v0] Error creating withdrawal:', e);
                return { ok: false, error: e.message };
            }
        }

        function showUserInfo() {
            const info = document.getElementById('user-info');
            if (user) {
                info.innerHTML = `
                    <span class="block font-semibold">ðŸ‘¤ ${user.first_name} ${user.last_name || ''}</span>
                    <span class="block text-xs opacity-80">ID: ${user.id}</span>
                `;
            } else {
                info.innerHTML = `<span>Not Authenticated</span>`;
            }
        }

        // Card component for user stats
        function userStatsCard() {
            return `
                <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white rounded-xl shadow p-5 flex flex-col items-center">
                        <span class="text-gray-500 text-xs mb-1">User Number</span>
                        <span class="text-lg font-bold">${user ? user.id : '-'}</span>
                    </div>
                    <div class="bg-white rounded-xl shadow p-5 flex flex-col items-center">
                        <span class="text-gray-500 text-xs mb-1">Balance</span>
                        <span class="text-lg font-bold text-green-600">$${currentBalance.toFixed(2)}</span>
                    </div>
                    <div class="bg-white rounded-xl shadow p-5 flex flex-col items-center">
                        <span class="text-gray-500 text-xs mb-1">Completed Tasks</span>
                        <span class="text-lg font-bold text-blue-700">${totalCompletedTasks}</span>
                    </div>
                    <div class="bg-white rounded-xl shadow p-5 flex flex-col items-center">
                        <span class="text-gray-500 text-xs mb-1">Referrals</span>
                        <span class="text-lg font-bold text-purple-700">${userData?.referral_count || 0}</span>
                    </div>
                    <div class="bg-white rounded-xl shadow p-5 flex flex-col items-center">
                        <span class="text-gray-500 text-xs mb-1">Referral Bonus</span>
                        <span class="text-lg font-bold text-green-700">$${(userData?.referral_bonus || 0).toFixed(2)}</span>
                    </div>
                </section>
            `;
        }

        // Home Section with Start Earning Button
        function homeSection() {
            return `
                <h1 class="text-2xl font-bold mb-4">Welcome${user ? ', ' + user.first_name : ''}!</h1>
                ${userStatsCard()}
                <div class="flex justify-center mb-6">
                    <button id="start-earning-btn" class="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-green-400 text-white px-6 py-3 rounded-full shadow-lg font-semibold text-lg hover:scale-105 transition-transform">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                        Start Earning
                    </button>
                </div>
                <section>
                    <p class="text-gray-700">This is the Home page of your Telegram Mini App. Here you can see your account summary and stats.</p>
                </section>
            `;
        }

        // Task Card Component
        function taskCard({id, title, description, reward, idx}) {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mb-5 flex flex-col sm:flex-row items-center gap-4 border border-blue-100 hover:shadow-2xl transition-shadow">
                    <div class="flex-1">
                        <h2 class="text-lg font-bold text-blue-700 flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.967a1 1 0 00.95.69h4.175c.969 0 1.371 1.24.588 1.81l-3.38 2.455a1 1 0 00-.364 1.118l1.287 3.966c.3.921-.755 1.688-1.54 1.118l-3.38-2.454a1 1 0 00-1.175 0l-3.38 2.454c-.784.57-1.838-.197-1.54-1.118l1.287-3.966a1 1 0 00-.364-1.118L2.049 9.394c-.783-.57-.38-1.81.588-1.81h4.175a1 1 0 00.95-.69l1.286-3.967z"/></svg>
                            ${title}
                        </h2>
                        <p class="text-gray-600 mb-3">${description}</p>
                        <span class="inline-block bg-green-100 text-green-700 text-xs px-3 py-1 rounded-full font-semibold mb-2">Reward: $${parseFloat(reward).toFixed(2)}</span>
                    </div>
                    <button class="do-task-btn flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full font-semibold shadow transition" data-idx="${idx}" data-reward="${reward}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"></path></svg>
                        Do Task
                    </button>
                </div>
            `;
        }

        async function taskSection() {
            const tasks = await fetchTasks();
            
            const tasksHTML = tasks.length > 0 
                ? tasks.map((task, idx) => taskCard({...task, idx})).join('')
                : '<p class="text-gray-500">No tasks available at the moment.</p>';
            
            setTimeout(() => {
                document.querySelectorAll('.do-task-btn').forEach((btn) => {
                    btn.onclick = () => {
                        const reward = btn.getAttribute('data-reward');
                        showAdAndReward(reward, () => {
                            loadTask();
                        });
                    };
                });
            }, 0);
            
            return `
                <h1 class="text-2xl font-bold mb-4">Tasks</h1>
                <div>
                    ${tasksHTML}
                </div>
                <section class="mt-6">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg flex items-center gap-3">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"></path></svg>
                        <span class="text-blue-700 font-medium">Complete more tasks to earn higher rewards and unlock achievements!</span>
                    </div>
                </section>
            `;
        }

        // Add modal HTML to the body
        const adModalHTML = `
        <div id="ad-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 max-w-sm w-full text-center relative">
                <h2 class="text-xl font-bold mb-4">Sponsored Ad</h2>
                <p class="mb-6">Watch this ad to earn your reward!</p>
                <div class="mb-6">
                    <img src="https://placehold.co/300x150?text=Ad+Banner" alt="Ad" class="rounded-lg mx-auto">
                </div>
                <div id="ad-timer" class="text-blue-700 font-semibold mb-4">5</div>
                <button id="ad-close-btn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold" disabled>Close</button>
            </div>
        </div>
        `;
        document.body.insertAdjacentHTML('beforeend', adModalHTML);

        // Show ad modal and handle reward
        function showAdAndReward(reward, onComplete) {
            const modal = document.getElementById('ad-modal');
            const timerEl = document.getElementById('ad-timer');
            const closeBtn = document.getElementById('ad-close-btn');
            
            let countdown = 5;
            timerEl.textContent = countdown;
            closeBtn.disabled = true;
            closeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            modal.classList.remove('hidden');

            const timer = setInterval(() => {
                countdown--;
                timerEl.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(timer);
                    timerEl.textContent = 'Ad Complete!';
                    closeBtn.disabled = false;
                    closeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    closeBtn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');
                }
            }, 1000);

            closeBtn.onclick = async () => {
                if (countdown <= 0) {
                    await rewardUserForTask(user.id, reward);
                    modal.classList.add('hidden');
                    if (typeof onComplete === 'function') onComplete();
                }
            };
        }

        async function rewardUserForTask(userId, rewardAmount) {
            try {
                // Fetch current user data
                const currentUser = await fetchUserData(userId);
                if (!currentUser) {
                    // Create user if doesn't exist
                    await upsertUser(userId, user.first_name);
                    const newUser = await fetchUserData(userId);
                    if (!newUser) throw new Error('Failed to create user');
                    userData = newUser;
                }

                // Calculate new values
                const newBalance = (userData.balance || 0) + parseFloat(rewardAmount);
                const newCompletedTasks = (userData.completed_tasks || 0) + 1;

                // Update user in Supabase
                const { error } = await supabase
                    .from('users')
                    .update({
                        balance: newBalance,
                        completed_tasks: newCompletedTasks
                    })
                    .eq('id', userId);

                if (error) throw error;

                // Update local variables
                currentBalance = newBalance;
                totalCompletedTasks = newCompletedTasks;
                userData.balance = newBalance;
                userData.completed_tasks = newCompletedTasks;

                // Refresh home view
                loadHome();
                alert(`Congratulations! You earned $${parseFloat(rewardAmount).toFixed(2)}`);
            } catch (e) {
                console.error('[v0] Error rewarding user:', e);
                alert('Error rewarding user: ' + e.message);
            }
        }

        // Navbar navigation
        const mainContent = document.getElementById('main-content');
        
        function setActive(navId) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-blue-700');
                btn.classList.add('text-gray-500');
            });
            document.getElementById(navId).classList.remove('text-gray-500');
            document.getElementById(navId).classList.add('text-blue-700');
        }

        function loadHome() {
            mainContent.innerHTML = homeSection();
            setActive('nav-home');
            setTimeout(() => {
                const btn = document.getElementById('start-earning-btn');
                if (btn) btn.onclick = loadTask;
            }, 0);
        }
        
        async function loadTask() {
            mainContent.innerHTML = '<div class="text-center py-8">Loading tasks...</div>';
            mainContent.innerHTML = await taskSection();
            setActive('nav-task');
        }
        
        function loadReffer() {
            const userId = user ? user.id : '';
            const referralLink = userId
                ? `https://t.me/YOUR_BOT_USERNAME?start=${userId}`
                : 'Login to get your referral link';

            mainContent.innerHTML = `
                <h1 class="text-2xl font-bold mb-4">Refer & Earn</h1>
                <section class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-semibold mb-2 text-blue-700">Invite Friends & Earn Rewards!</h2>
                    <p class="text-gray-700 mb-4">
                        Share your unique referral link with friends. When they join and complete their first task, you both earn a bonus!
                    </p>
                    <div class="mb-4">
                        <span class="block text-gray-600 mb-1 font-medium">Your Referral Link:</span>
                        <div class="flex items-center gap-2">
                            <input type="text" readonly value="${referralLink}" class="flex-1 px-3 py-2 border rounded bg-gray-100 text-gray-800 text-sm" id="ref-link-input">
                            <button onclick="copyReferralLink('${referralLink}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-semibold">Copy</button>
                        </div>
                    </div>
                    <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded flex items-center gap-3 mt-4">
                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"></path></svg>
                        <span class="text-green-700 font-medium">Referral Bonus: <span class="font-bold">$0.25</span> for each friend who joins!</span>
                    </div>
                </section>
            `;
            setActive('nav-reffer');
        }

        function copyReferralLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('Referral link copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy link');
            });
        }

        function loadWallet() {
            mainContent.innerHTML = `
                <h1 class="text-2xl font-bold mb-4">Wallet</h1>
                <section class="bg-white rounded-xl shadow p-6 mb-4">
                    <div class="flex flex-col sm:flex-row sm:justify-between gap-4">
                        <div>
                            <span class="block text-gray-500 text-xs mb-1">Balance</span>
                            <span class="text-lg font-bold text-green-600">$${currentBalance.toFixed(2)}</span>
                        </div>
                        <div>
                            <span class="block text-gray-500 text-xs mb-1">User Number</span>
                            <span class="text-lg font-bold">${user ? user.id : '-'}</span>
                        </div>
                    </div>
                </section>
                <section>
                    <p class="text-gray-700 mb-4">Manage your wallet and transactions here.</p>
                    <button id="withdraw-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded font-semibold shadow transition disabled:opacity-60" ${currentBalance < 10 ? 'disabled' : ''}>
                        Withdraw
                    </button>
                    <span class="block text-xs text-gray-500 mt-2">Minimum withdraw amount is $10</span>
                </section>
                <div id="withdraw-modal-root"></div>
            `;
            setActive('nav-wallet');

            setTimeout(() => {
                const withdrawBtn = document.getElementById('withdraw-btn');
                if (withdrawBtn) {
                    withdrawBtn.onclick = () => showWithdrawModal();
                }
            }, 0);
        }

        // Withdraw Modal
        function showWithdrawModal() {
            const modalRoot = document.getElementById('withdraw-modal-root');
            modalRoot.innerHTML = `
                <div id="withdraw-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm relative">
                        <h2 class="text-xl font-bold mb-4 text-blue-700">Withdraw Request</h2>
                        <form id="withdraw-form" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">Payment Method</label>
                                <select id="payment-method" class="w-full border rounded px-3 py-2" required>
                                    <option value="">Select</option>
                                    <option value="bkash">bKash</option>
                                    <option value="nagad">Nagad</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">Number</label>
                                <input id="payment-number" type="text" maxlength="11" pattern="\\d{11}" class="w-full border rounded px-3 py-2" placeholder="e.g. 01XXXXXXXXX" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">Amount ($)</label>
                                <input id="withdraw-amount" type="number" min="10" max="${Math.floor(currentBalance)}" class="w-full border rounded px-3 py-2" value="10" required>
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" id="withdraw-cancel" class="bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold">Cancel</button>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('withdraw-cancel').onclick = () => {
                modalRoot.innerHTML = '';
            };

            document.getElementById('withdraw-form').onsubmit = function(e) {
                e.preventDefault();
                const method = document.getElementById('payment-method').value;
                const number = document.getElementById('payment-number').value;
                const amount = parseFloat(document.getElementById('withdraw-amount').value);

                if (!method || !/^\d{11}$/.test(number) || isNaN(amount) || amount < 10 || amount > currentBalance) {
                    alert('Please fill all fields correctly.');
                    return;
                }

                showWithdrawConfirm({method, number, amount});
            };
        }

        // Confirm/Decline Modal
        function showWithdrawConfirm({ method, number, amount }) {
            const modalRoot = document.getElementById('withdraw-modal-root');
            modalRoot.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm relative">
                        <h2 class="text-xl font-bold mb-4 text-blue-700">Confirm Withdraw</h2>
                        <div class="mb-4">
                            <div class="mb-2"><span class="font-semibold">Method:</span> ${method}</div>
                            <div class="mb-2"><span class="font-semibold">Number:</span> ${number}</div>
                            <div class="mb-2"><span class="font-semibold">Amount:</span> $${amount.toFixed(2)}</div>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button id="withdraw-decline" class="bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold">Decline</button>
                            <button id="withdraw-confirm" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Confirm</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('withdraw-decline').onclick = () => {
                modalRoot.innerHTML = '';
            };
            
            document.getElementById('withdraw-confirm').onclick = async () => {
                const result = await sendWithdrawRequest({
                    userId: user ? user.id : '',
                    method,
                    number,
                    amount
                });
                modalRoot.innerHTML = '';
                if (result.ok) {
                    currentBalance -= amount;
                    userData.balance = currentBalance;
                    alert('Withdraw request submitted successfully!');
                    loadWallet();
                } else {
                    alert('Withdraw failed: ' + (result.error || 'Unknown error'));
                }
            };
        }

        // Extract referral ID from Telegram WebApp start parameter
        function getReferralId() {
            return tg.initDataUnsafe?.start_param || null;
        }

        async function initializeApp() {
            showUserInfo();
            
            if (!user) {
                loadHome();
                return;
            }

            // Fetch user data
            userData = await fetchUserData(user.id);
            
            if (!userData) {
                // New user - create with referral if present
                const referredBy = getReferralId();
                userData = await upsertUser(
                    user.id, 
                    user.first_name, 
                    referredBy && referredBy !== String(user.id) ? referredBy : null
                );
            }

            if (userData) {
                currentBalance = userData.balance || 0;
                totalCompletedTasks = userData.completed_tasks || 0;
            }

            loadHome();
        }

        // Navigation event listeners
        document.getElementById('nav-home').onclick = loadHome;
        document.getElementById('nav-task').onclick = loadTask;
        document.getElementById('nav-reffer').onclick = loadReffer;
        document.getElementById('nav-wallet').onclick = loadWallet;

        // Initialize app on page load
        initializeApp();
    </script>

     Monetag Ad Script 
    <script async="async" data-cfasync="false" src="//pl20548485.highcpmrevenuegate.com/1c6b4e2b3a2b6f7b7e1b6e2e3e3b3e2e/invoke.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='10044805' data-sdk='show_10044805'></script>
</body>
</html>
